---
title: "NSW Property - A Case Study"
output:
  html_document:
    toc: true
    toc_float: true
---
```{r echo = FALSE,message =FALSE, warning=FALSE}
library(ggplot2)
library(ggrepel)
library(dplyr)
library(sf)
library(knitr)
library(kableExtra)
library(corrplot)

data <- readRDS("rmarkdown_data.rds")
units <- readRDS("units.rds")
sydney <- readRDS("map_sydney.rds")
rest <- readRDS("map_rest.rds")
centroid <- readRDS("centroids.rds")
data_set_year <- readRDS("data_set_year.rds")
data_set_allocation <- readRDS("data_set_allocation.rds")

growth_by_sa4 <- data %>%
    filter(year == 2019) %>%
    group_by(sa4_name,gccsa_name) %>%
    summarise(average = mean(index)) 

unit_growth_by_sa4 <- units %>%
    filter(year == 2019) %>%
    group_by(sa4_name,gccsa_name) %>%
    summarise(average = mean(index)) 
```

## Houses - A Story of Growth
The overwhelming sentiment in Australia is that investing in houses is as safe as putting money in the bank, except the value of the house will double every 7 years. These two features, security and growth, are typically considered to be competing forces and are what the Risk/Return trade-off characterises. 

This case study looks at NSW property over the last 20 years and finds that for the most part, this trade-off hasn't applied. Over the last year there has been discussion of a burst Sydney property bubble, but that seems to have been overwhelmingly answered over the past several months of growth. This case study will not extend to that bounceback as it considers only the period from 2000 until the end of June 2019.

<br>

### 1 - A Story of Growth
<br>
If you were looking at buying a house in NSW in the year 2000, you basically couldn't go wrong. Prices weren't yet outrageous as there hadn't been all that much growth over the proceeding 10 years. Across NSW, the median house price was $`r data %>% filter(year == 2000) %>% summarise(median = median(house_median)) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`. In Sydney, this was a bit higher at $`r data %>% filter(year == 2000) %>% filter(gccsa_name == "Greater Sydney") %>% summarise(median = median(house_median)) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`.

The median return over the next 20 years was `r data %>% filter(year == 2019) %>% summarise(median = median(index)) %>% mutate(median = median -100) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`% (that's equivalent to nearly tripling your original investment and equates to an annual return of 7.5% per annum), with the absolute worst return being `r data %>% filter(year == 2019) %>% summarise(min = min(index)) %>% mutate(min = min -100) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`% at `r data %>% filter(year == 2019) %>% arrange(index) %>% select(suburb_name) %>% head(1)`. On the other hand, the average person who bought a house in `r data %>% filter(year == 2019) %>% arrange(desc(index)) %>% select(suburb_name) %>% head(1)`, saw a growth rate of `r data %>% filter(year == 2019) %>% summarise(max = max(index)) %>% mutate(max = max -100) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`% (equivalent to 14.3% per annum). 

The below graph shows how much of the state grew solidly between 2001 and 2004, plateaued between 2005 and 2009 and then resumed growth from 2009, significantly so after 2012. Interestingly, these movements coincide strongly with [RBA Cash Rate](https://www.rba.gov.au/statistics/cash-rate/) reductions (between February 2001 and December 2001 the Cash Rate fell 2%, between September 2008 and April 2009 the Cash Rate fell 4.25% and there has been a slow reduction down to 0.75% since November 2011). This is highlighted in the below graph where reductions in the Cash Rate (i.e. Expansionary Policy) are shown in green and increases (i.e. Contractionary Policy) in red. 

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  ggplot(data,aes(x = year, y = index, group = suburb_name)) + 
    geom_line(alpha = 0.05) +
    ggtitle("Houses - A Story of Growth") +
    theme_minimal() +
    theme(plot.title = element_text(hjust=0.5)) +
    geom_hline(yintercept=100, linetype="dashed", color = "red") + 
    scale_y_continuous(breaks = c(100,500,1000)) + 
    labs(x = "Year", y = "Price Index from Year 2000") +
    annotate("rect", xmin=2001.1, xmax=2001.9, ymin=0, ymax=Inf, alpha=0.1, fill="green") + 
    annotate("rect", xmin=2008.7, xmax=2009.3, ymin=0, ymax=Inf, alpha=0.1, fill="green") + 
    annotate("rect", xmin=2011.9, xmax=2019, ymin=0, ymax=Inf, alpha=0.1, fill="green") +
    annotate("rect", xmin=2002.4, xmax=2008.3, ymin=0, ymax=Inf, alpha=0.1, fill="red") + 
    annotate("rect", xmin=2009.8, xmax=2010.9, ymin=0, ymax=Inf, alpha=0.1, fill="red")
```

### 2 - Regional NSW Grew First
<br>
The prevailing wisdom regarding property prices seems to be that property prices tend to rise fastest in the Australian capital cities, particularly Sydney and Melbourne. While the data sees this over the last 7 years, the story isn't as strong in the first property boom of this millenium. 

The below graph shows the above data, but splits the state into Greater Sydney and the rest of NSW. What is clear is that initially regional areas grow faster and it is only in later year that Sydney catches up and in some areas surpases the regional growth.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  ggplot(data,aes(x = year, y = index, group = suburb_name, colour = gccsa_name)) + 
      geom_line(alpha = 0.1) +
      scale_y_continuous(breaks = c(100,500,1000)) +
      ggtitle("Regional NSW Grew First") +
      labs(x = "Year", y = "Price Index from Year 2000", colour = "Region") +
      theme_minimal()+
      theme(plot.title = element_text(hjust=0.5)) +
      theme(legend.position="bottom") + 
      guides(colour = guide_legend(override.aes = list(alpha = 1)))
```

### 3 - Which Regions Grew the Most?
<br>
The table below shows the average cumulative growth in house prices for all 28 statistical level 4 (SA4) regions of NSW. While the Eastern Suburbs of Sydney are way out ahead of the pack, the average index score for all SA4s has at least doubled from 100 at the start of the year 2000 to over 200 all over the state.

```{r echo = FALSE,message =FALSE, warning=FALSE, fig.width = 3}
  table_1 <- growth_by_sa4 %>%
    rename(SA4 = sa4_name,
           `Average Price Index in 2019` = average,
           `Greater Sydney or Rest of NSW` = gccsa_name) %>%
    arrange(desc(`Average Price Index in 2019`))

  kable(table_1) %>%
    kable_styling(bootstrap_options = c("striped", "hover","condensed")) %>%
    row_spec(c(1,6,9,10,12:14,16:22,25), background = "#fddfdd") %>% #Greater Sydney
    row_spec(c(2:5,7,8,11,15,23,24,26:28), background = "#ebfeff") # Rest of NSW
```

Visualising these figures on the map of NSW shows an obvious bias towards coastal regions, but also a slight lull for the coastal regions which are closer to Greater Sydney. This might suggest a preference to either be in the thick of it on Bondi Beach or get away from everything, except the beach. 

```{r echo = FALSE,message =FALSE, warning=FALSE, fig.width=4.2, fig.height=4.2, fig.show = 'hold'}
  rest_growth <- rest %>%
    left_join(growth_by_sa4)
  
  ggplot(rest_growth) +
    geom_sf(mapping = aes(fill = average)) +
    scale_fill_continuous(type = "viridis",limits = c(200,600)) +
    ggtitle("Average Price Index - Rest of NSW") +
    labs(fill = "Average Price Index in 2019") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom", legend.key.width = unit(0.7,"cm"))
  
  sydney_growth <- sydney %>%
    left_join(growth_by_sa4)
  
  ggplot(sydney_growth) +
    geom_sf(mapping = aes(fill = average)) +
    scale_fill_continuous(type = "viridis",limits = c(200,600)) +
    ggtitle("Average Price Index - Greater Sydney") +
    labs(fill = "Average Price Index in 2019") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom", legend.key.width = unit(0.7,"cm"))
  
```

### 4 - Top 10 Regional Suburbs

The next focus is to look more closely at the top 20 suburbs in 2019, which conveniently split into two groups of 10 based on being in Greater Sydney or Regional NSW.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  ggplot(data %>% 
           filter(gccsa_name == "Rest of NSW") %>% 
           arrange(desc(top)) %>%
           head(200),
         aes(x = year, y = index, group = suburb_name, colour = sa4_name)) + 
    geom_line() +
    geom_text_repel(data = data %>% 
                      filter(gccsa_name == "Rest of NSW") %>% 
                      arrange(desc(top)) %>%
                      head(200) %>%
                      group_by(suburb_name) %>%
                      arrange(desc(year)) %>%
                      slice(1),
                    aes(x = year + 0.2, label = suburb_name), 
                    direction = "y",hjust = -0.5, size= 3, segment.alpha = 0.4) + 
    scale_x_continuous(expand = c(0.1,0.1,0.3,0)) +
    scale_y_continuous(breaks = c(100,500,1000)) +
    ggtitle("Top 10 - Rest of NSW") +
    labs(x = "Year", y = "Price Index from year 2000", colour = "SA4") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom") + 
    guides(colour = guide_legend(override.aes = list(alpha = 1)))
```

It's probably not obvious exactly where these suburbs are, so I've shown them on the map. We can now see a cluster of high performing suburbs in Newcastle, as well as a cluster around Byron Bay and near Canberra (as I only have access to NSW data the ACT is not visible, but based on this evidence Canberra might have seen some solid growth over the last 20 years).

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  
top_rest <- data %>%
    filter(year == 2019) %>%
    filter(gccsa_name == "Rest of NSW") %>% 
    arrange(desc(top)) %>%
    head(10)
  
top_rest_points <- centroid %>%
    semi_join(top_rest) %>%
    mutate(x = st_coordinates(geometry)[,1],
           y = st_coordinates(geometry)[,2]) 

ggplot(rest) +
    geom_sf() +
    geom_sf(data = rest %>% filter(sa4_name %in% c("Capital Region",
                                                   "Hunter Valley exc Newcastle",
                                                   "Richmond - Tweed",
                                                   "Coffs Harbour - Grafton",
                                                   "Newcastle and Lake Macquarie",
                                                   "Riverina")),
            mapping = aes(fill = sa4_name)) +
    geom_point(data = top_rest_points,mapping = aes(x,y), colour = "red") +
    geom_label_repel(data = top_rest_points,
                     mapping = aes(x,y,label = suburb_name),
                     size = 2.5) +
    ggtitle("Top 10 - Rest of NSW") +
    labs(fill = "SA4") +
    theme_minimal() +
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom",
          axis.title.x=element_blank(),
          axis.title.y=element_blank())
```

### 5 - Top 10 Greater Sydney Suburbs

Turning attention to Sydney, St Leonards has had some very perculiar growth (at least in 2017 and 2018), while Queenscliff north of Manly has consistently been a top performer.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  ggplot(data %>% 
           filter(gccsa_name == "Greater Sydney") %>% 
           arrange(desc(top)) %>%
           head(200),
         aes(x = year, y = index, group = suburb_name, colour = sa4_name)) + 
    geom_line() +
    geom_text_repel(data = data %>% 
                      filter(gccsa_name == "Greater Sydney") %>% 
                      arrange(desc(top)) %>%
                      head(200) %>%
                      group_by(suburb_name) %>%
                      arrange(desc(year)) %>%
                      slice(1),
                    aes(x = year + 0.2, label = suburb_name), 
                    direction = "y",hjust = -0.5, size= 3, segment.alpha = 0.4) + 
    scale_x_continuous(expand = c(0.1,0.1,0.3,0)) +
    scale_y_continuous(breaks = c(100,500,1000)) +
    ggtitle("Top 10 - Greater Sydney") +
    labs(x = "Year", y = "Price Index from Year 2000", colour = "SA4") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom") + 
    guides(colour = guide_legend(override.aes = list(alpha = 1),
                                 nrow=2,byrow=TRUE))
```

Unsurprisingly, a number of suburbs in the Eastern Suburbs of Sydney feature in the top 10 best performing since 2000, but it is pretty hard to see anything here as the highly performing suburbs are all clustered very close to the centre of Sydney.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  
top_syd <- data %>%
    filter(year == 2019) %>%
    filter(gccsa_name == "Greater Sydney") %>% 
    arrange(desc(top)) %>%
    head(10)
  
  top_syd_points <- centroid %>%
    semi_join(top_syd) %>%
    mutate(x = st_coordinates(geometry)[,1],
           y = st_coordinates(geometry)[,2])  

ggplot(sydney) +
    geom_sf() +
    geom_sf(data = sydney %>% filter(sa4_name %in% c("Central Coast",
                                                   "Sydney - Eastern Suburbs",
                                                   "Sydney - North Sydney and Hornsby",
                                                   "Sydney - Northern Beaches")),
            mapping = aes(fill = sa4_name)) +
    geom_point(data = top_syd_points,mapping = aes(x,y), colour = "red") +
    geom_label_repel(data = top_syd_points,
                    mapping = aes(x,y,label = suburb_name),
                    direction = "both", size= 2.5, segment.alpha = 0.4) +
    scale_x_continuous(expand = c(0.1,0.1,0.3,0)) +
    ggtitle("Top 10 - Greater Sydney") +
    labs(fill = "SA4") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom",
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

Zooming in shows a couple of interesting stories. Being close to Sydney on the Northwest line seems to matter, while places like Darling Point and Double Bay may have benefitted from the lock-out laws in introduced in 2014. Perhaps strangely, only two beach suburbs, Queenscliff and Coogee, feature in the top 10.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}

ggplot(sydney) +
    geom_sf() +
    geom_sf(data = sydney %>% filter(sa4_name %in% c("Central Coast",
                                                     "Sydney - Eastern Suburbs",
                                                     "Sydney - North Sydney and Hornsby",
                                                     "Sydney - Northern Beaches")),
            mapping = aes(fill = sa4_name)) +
    coord_sf(xlim = c(151, 151.4), ylim = c(-34, -33.7), expand = FALSE) +
    geom_point(data = top_syd_points,mapping = aes(x,y), colour = "red") +
    geom_label_repel(data = top_syd_points,
                     mapping = aes(x,y,label = suburb_name),
                     direction = "both", size= 3, segment.alpha = 0.4) +
    scale_x_continuous(expand = c(0.1,0.1,0.3,0)) +
    ggtitle("Top 10 - Greater Sydney (Locations)") +
    labs(fill = "SA4") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom",
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

<br> 

## Apartments - Growing in the West

One big caveat to begin the story of apartments is that my data was fairly sparse before 2001. I put this down to the NSW Valuer General's focus expanding slightly from being primarily concerned with property sales on plots of land to being concerned with all property sales. For this reason I've indexed prices to 2001 median values rather than those in the year 2000.

### 6 - A Story of Growth
<br>
The median apartment price across the state in 2001 was $`r units %>% filter(year == 2001) %>% summarise(median = median(unit_median)) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`, which was actually higher than the median house price in 2001, at $`r data %>% filter(year == 2001) %>% summarise(median = median(house_median)) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`. But this just reflects the geographical distribution of apartments in NSW, being primarily in Sydney. Interestingly, it was only a bit below the median house in Sydney in 2001 at $`r data %>% filter(year == 2001) %>% filter(gccsa_name == "Greater Sydney") %>% summarise(median = median(house_median)) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`.

The median return over the next 19 years was `r units %>% filter(year == 2019) %>% summarise(median = median(index)) %>% mutate(median = median -100) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`%, with the absolute worst return being a reduction in the index value to only `r units %>% filter(year == 2019) %>% summarise(min = min(index)) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")` in `r units %>% filter(year == 2019) %>% arrange(index) %>% select(suburb_name) %>% head(1)`. On the other hand, the average person who bought an apartment in `r units %>% filter(year == 2019) %>% arrange(desc(index)) %>% select(suburb_name) %>% head(1)`, in Wollongong, saw a growth rate of `r units %>% filter(year == 2019) %>% summarise(max = max(index)) %>% mutate(max = max -100) %>% round(0) %>% pull() %>% format(digits = 2, big.mark = ",")`%. 

The below graph, puts the growth in apartment prices on the same scale as that for houses and overlays the RBA Cash Rate movements. As you can see, there is a less obvious trend, although it is still upward.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  ggplot(units,aes(x = year, y = index, group = suburb_name)) + 
    geom_line(alpha = 0.1) +
    ggtitle("Apartments - A Story of Growth") +
    theme_minimal() +
    theme(plot.title = element_text(hjust=0.5)) +
    geom_hline(yintercept=100, linetype="dashed", color = "red") + 
    scale_y_continuous(breaks = c(100,500,1000), limits = c(0,1500)) + 
    labs(x = "Year", y = "Price Index from year 2001") +
    annotate("rect", xmin=2001.1, xmax=2001.9, ymin=0, ymax=Inf, alpha=0.1, fill="green") + 
    annotate("rect", xmin=2008.7, xmax=2009.3, ymin=0, ymax=Inf, alpha=0.1, fill="green") + 
    annotate("rect", xmin=2011.9, xmax=2019, ymin=0, ymax=Inf, alpha=0.1, fill="green") +
    annotate("rect", xmin=2002.4, xmax=2008.3, ymin=0, ymax=Inf, alpha=0.1, fill="red") + 
    annotate("rect", xmin=2009.8, xmax=2010.9, ymin=0, ymax=Inf, alpha=0.1, fill="red")
```

### 7 - Top 10 Suburbs 

While there are apartments throughout the state, I've chosen to focus on Greater Sydney as this is where `r units %>% filter(year == 2019) %>% group_by(gccsa_name) %>% summarise(n=n()) %>% filter(gccsa_name == "Greater Sydney") %>% pull()` of the `r units %>% filter(year == 2019) %>% summarise(n=n()) %>% pull()` suburbs are with sufficient apartment sales every year to calculate the median price.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  ggplot(units %>% 
           filter(gccsa_name == "Greater Sydney") %>% 
           arrange(desc(top)) %>%
           head(190),
         aes(x = year, y = index, group = suburb_name, colour = sa4_name)) + 
    geom_line() +
    geom_text_repel(data = units %>% 
                      filter(gccsa_name == "Greater Sydney") %>% 
                      arrange(desc(top)) %>%
                      head(190) %>%
                      group_by(suburb_name) %>%
                      arrange(desc(year)) %>%
                      slice(1),
                    aes(x = year + 0.2, label = suburb_name), 
                    direction = "y",hjust = -0.5, size= 3, segment.alpha = 0.4) + 
    scale_x_continuous(expand = c(0.1,0.1,0.3,0)) +
    scale_y_continuous(breaks = c(100,500,1000)) +
    ggtitle("Top 10 - Greater Sydney") +
    labs(x = "Year", y = "Price Index from year 2001", colour = "SA4") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom") + 
    guides(colour = guide_legend(override.aes = list(alpha = 1),
                                 nrow=2,byrow=TRUE))
```

The below maps expands on a really interesting finding, apartment price growth is clustered to the south and west of the city. A complete contrast to the above house price growth. In fact, the only statistical area 4 which has any overlap in top 10 performers is the Central Coast. 

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  
top_syd_unit <- units %>%
    filter(year == 2019) %>%
    filter(gccsa_name == "Greater Sydney") %>% 
    arrange(desc(top)) %>%
    head(10)
  
  top_syd_points_unit <- centroid %>%
    semi_join(top_syd_unit) %>%
    mutate(x = st_coordinates(geometry)[,1],
           y = st_coordinates(geometry)[,2]) 

ggplot(sydney) +
    geom_sf() +
    geom_sf(data = sydney %>% filter(sa4_name %in% c("Central Coast",
                                                     "Sydney - City and Inner South",
                                                     "Sydney - Outer South West",
                                                     "Sydney - Outer West and Blue Mountains",
                                                     "Sydney - Inner West",
                                                     "Sydney - South West")),
            mapping = aes(fill = sa4_name)) +
    geom_point(data = top_syd_points_unit,mapping = aes(x,y), colour = "red") +
    geom_label_repel(data = top_syd_points_unit,
                     mapping = aes(x,y,label = suburb_name),
                     direction = "both", size= 3, segment.alpha = 0.4) +
    scale_x_continuous(expand = c(0.1,0.1,0.3,0)) +
    ggtitle("Top 10 Suburbs - Apartments - Greater Sydney") +
    labs(fill = "SA4") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom",
          axis.title.x=element_blank(),
          axis.title.y=element_blank()) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

unit_growth_by_sa4 <- units %>%
    filter(year == 2019) %>%
    group_by(sa4_name,gccsa_name) %>%
    summarise(average = mean(index)) 
  
  unit_sydney_growth <- sydney %>%
    left_join(unit_growth_by_sa4)
  
  ggplot(unit_sydney_growth) +
    geom_sf(mapping = aes(fill = average)) +
    scale_fill_continuous(type = "viridis",limits = c(200,350)) +
    ggtitle("Average Price Index - Greater Sydney") +
    labs(fill = "Average Price Index in 2019") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom", legend.key.width = unit(0.7,"cm"))
```

### 8 - Getting Rich off the Lock-Out?

Earlier I touched on the lock-out laws potentially having an impact on house prices to the east of the city. In fact, any change is more likely to be seen in the value of apartments as they make up more than 80% of the properties in the affected areas.

The below graph shows the 9 suburbs where lockout laws are in place and illustrates the February 2014 introduction as a dashed red line. Based on this graph, it very much appears as though the lockout laws had a positive impact on apartment prices.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  ggplot(units %>%
           filter(suburb_name %in% c("Pyrmont",
                                     "Ultimo",
                                     "Chippendale",
                                     "Haymarket",
                                     "Surry Hills",
                                     "Elizabeth Bay",
                                     "Rushcutters Bay",
                                     "Darlinghurst",
                                     "Woolloomooloo")), 
         aes(x = year, y = index, group = suburb_name)) + 
    geom_line() +
    geom_text_repel(data = units %>%
                      filter(suburb_name %in% c("Pyrmont",
                                                "Ultimo",
                                                "Chippendale",
                                                "Haymarket",
                                                "Surry Hills",
                                                "Elizabeth Bay",
                                                "Rushcutters Bay",
                                                "Darlinghurst",
                                                "Woolloomooloo")) %>%
                      group_by(suburb_name) %>%
                      arrange(desc(year)) %>%
                      slice(1),
                    aes(x = year + 0.2, label = suburb_name), 
                    direction = "y",hjust = -0.5, size= 3, segment.alpha = 0.4) + 
    geom_vline(xintercept = 2014.15, linetype="dashed", color = "red") +
    scale_x_continuous(expand = c(0.1,0.1,0.3,0)) +
    scale_y_continuous(breaks = c(100,200,300,400,500)) +
    ggtitle("Lockout Impact") +
    labs(x = "Year", y = "Price Index from year 2001", colour = "SA4") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom") + 
    guides(colour = guide_legend(override.aes = list(alpha = 1),
                                 nrow=2,byrow=TRUE))
```

The below graph dispels that thought however, as it shows nothing special at all happening in the Sydney Inner City Statistical Area 3 (SA3) where all of these suburbs reside, relative to other central Sydney suburbs. Interestingly, this is the first time the 2018-19 reduction in prices looks obvious.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  lockout_agg <- units %>%
    filter(sa4_name %in% c("Sydney - Inner West",
                           "Sydney - City and Inner South",
                           "Sydney - Eastern Suburbs")) %>%
    group_by(sa3_name, year) %>%
    summarise(average_index = mean(index))
    
  
  ggplot(lockout_agg, aes(x = year, y = average_index, group = sa3_name, colour = sa3_name)) + 
    geom_line() +
    geom_text_repel(data = lockout_agg %>% 
                      group_by(sa3_name) %>%
                      arrange(desc(year)) %>%
                      slice(1),
                    aes(x = year + 0.2, label = sa3_name), 
                    direction = "y",hjust = -0.5, size= 3, segment.alpha = 0.4) + 
    geom_vline(xintercept = 2014.15, linetype="dashed", color = "red") +
    scale_x_continuous(expand = c(0.1,0.1,0.3,0)) +
    scale_y_continuous(breaks = c(100,200,300,400,500)) +
    ggtitle("Lockout Impact - Myth Busted?") +
    labs(x = "Year", y = "Price Index from year 2001", colour = "SA4") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position = "none")
```

<br>

## Understanding Variable Importance

As shown on the introduction page, there are a number of data sets which have been combined with the core property sale data to try to understand suburb characteristics. Importantly, these data sets run on time scales which may not align with the property sales data (covering 1990 to 2019, although units were only properly captured from 2001).

The following table summarises each data set's timeframe and provides an explanation for how they were transformed.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
  kable(data_set_year) %>%
    kable_styling(bootstrap_options = c("striped", "hover","condensed"))
```

While some variables I've included would suggest powerful predictive capabilities, such as the ARIA scores for access to services or my proxy for Green Space, in a modelling context they are not going to be useful as they have a single value which does not change over time, and was obtained much later than some of the data.

On the other hand, the SEIFA indexes coming out of the ABS and the other Census measures probably can be used to try to understand the impact they have on house or unit prices. Given they are calculated at 5 year windows (within a changing suburb environment) they are far from perfect, but given the fairly logical transformations I have completed, they have some modeling usefulness.

One further transformation I have completed is to try and control for the general growth in values over time. Leaving this in basically shows years as the most relevant variable by far and this is simply because of the very strong growth trend seen over the past 20 years. By first taking the suburb median and then dividing by the NSW median, I am able to control for the general upward movement in the state to a certain degree.

<br>

### 9 - Variable Importance 2001 - 2019

The following graph shows the variable importance scores coming from a random forest generated to model the NSW growth adjusted index from 2001 - 2019, using only the variables available for that period.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}

house_2001_rf_fit <- readRDS("house_2001_rf_fit.rds")

rf_imp_house_2001 <- as_tibble(house_2001_rf_fit$fit$importance, rownames = "variable") %>%
    mutate(importance = (IncNodePurity - min(IncNodePurity)) / (max(IncNodePurity) - min(IncNodePurity))) %>%
    left_join(data_set_allocation, by = "variable")

ggplot(rf_imp_house_2001,aes(x = reorder(variable,importance),y = importance,fill = data_set)) + 
    geom_bar(stat = "identity") + 
    coord_flip() + 
    ggtitle("Houses - Variable Importance 2001 - 2019") +
    labs(y = "Normalised Variable Importance", x = "Variable", fill = "Data Set") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom") +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

The above chart, showing variable importance when the dependent variable is house prices, illustrates that the SEIFA indexes carry a fair bit of information. The model built using these variables explains about `r round(max(house_2001_rf_fit$fit$rsq),3)*100`% of the variance in the dependent variable. 

The below chart, covering apartment prices assigns less importance to the SEIFA indexes, but they are still much more relevant than crime values and the gross amount of turnover in property. This model is explaining about `r round(max(house_2001_rf_fit$fit$rsq),3)*100`% of the variance in the data.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
unit_2001_rf_fit <- readRDS("unit_2001_rf_fit.rds")

rf_imp_unit_2001 <- as_tibble(unit_2001_rf_fit$fit$importance, rownames = "variable") %>%
    mutate(importance = (IncNodePurity - min(IncNodePurity)) / (max(IncNodePurity) - min(IncNodePurity))) %>%
    left_join(data_set_allocation, by = "variable")

ggplot(rf_imp_unit_2001,aes(x = reorder(variable,importance),y = importance,fill = data_set)) + 
    geom_bar(stat = "identity") + 
    coord_flip() + 
    ggtitle("Apartments - Variable Importance 2001 - 2019") +
    labs(y = "Normalised Variable Importance", x = "Variable", fill = "Data Set") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom") +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

<br>

### 10 - Variable Importance 2006 - 2019

While a random forest can calculate variable importance over variables with missing values, it is actually interpolating a value in some fashion (often the mean) and so doesn't make a whole lot of sense. It therefore makes a bit more sense to shorten the window when looking to include Census data which I have since 2006. 

The below graphs shows the normalised variable importance from two more random forests, one each for houses and apartments. 

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
house_2006_rf_fit <- readRDS("house_2006_rf_fit.rds")

rf_imp_house_2006 <- as_tibble(house_2006_rf_fit$fit$importance, rownames = "variable") %>%
    mutate(importance = (IncNodePurity - min(IncNodePurity)) / (max(IncNodePurity) - min(IncNodePurity))) %>%
    left_join(data_set_allocation, by = "variable")

ggplot(rf_imp_house_2006,aes(x = reorder(variable,importance),y = importance,fill = data_set)) + 
    geom_bar(stat = "identity") + 
    coord_flip() + 
    ggtitle("Houses - Variable Importance 2006 - 2019") +
    labs(y = "Normalised Variable Importance", x = "Variable", fill = "Data Set") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom") +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

Once again the SEIFA indexes for education/employment resources and advantage/disadvanage feature highly. Interestingly however, the proportion of journeys to work by public transport is now above the time variable and several other census scores relating to transport and the make properties have relevant importance. 

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
unit_2006_rf_fit <- readRDS("unit_2006_rf_fit.rds")

rf_imp_unit_2006 <- as_tibble(unit_2006_rf_fit$fit$importance, rownames = "variable") %>%
    mutate(importance = (IncNodePurity - min(IncNodePurity)) / (max(IncNodePurity) - min(IncNodePurity))) %>%
    left_join(data_set_allocation, by = "variable")

ggplot(rf_imp_unit_2006,aes(x = reorder(variable,importance),y = importance,fill = data_set)) + 
    geom_bar(stat = "identity") + 
    coord_flip() + 
    ggtitle("Apartments - Variable Importance 2006 - 2019") +
    labs(y = "Normalised Variable Importance", x = "Variable", fill = "Data Set") +
    theme_minimal()+
    theme(plot.title = element_text(hjust=0.5)) +
    theme(legend.position="bottom") +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))
```

### 11 - How Variables Explain Prices

While a random forest does a useful job of identifying influential variables, it doesn't give a clear indication of how the dependent variable (price index controlled for NSW price growth) is influenced by the independent variables (everything else, but in this case only the variables with some importance from the previous section).

For this job it can be best to use a simple linear model, but first it is important to consider correlated variables as including variables which are not independent will generate some strange results. There are a couple of strong candidates for correlation within the existing list of variable importance. Some of these aris from being a nearly complete measure (i.e. public transport vs motor vehicle & house proportion vs unit proportion), while others might be measuring similar variables (such as the case with the 4 SEIFA indexes)

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
cor_calc <- readRDS("cor_calc.rds")

corrplot(cor_calc, method="color")
```

The correlation plot indicates that there are in fact independence concerns with several of the variables. The clashes seem to be:

* Usual Resident Population vs Confirmed Journeys vs Confirmed Dwellings
* Proportion of People Working Age vs Proportion of Senior Citizens
* Proportion of Journeys by Public Transport vs Proportion of Journeys by Motor Vehicle
* Proportion of Houses vs Proportion of Units
* SEIFA Index of Disadvantage vs SEIFA Index of Advantage & Disadvantage.

In each case I will take the variable with the higher importance based on the random forest variable importance. This means, confirmed journeys and dwellings, the proportion of people working age, proportion of journeys by motor vehicle, proportion of houses and SEIFA Index of Disadvantage will all be removed, but I must stress this is sort of arbitrary and I could just have easily removed the other side.

The below table shows the coefficients and p-values from linear models calculated on the NSW controlled 2006 - 2019 price indexes for houses and apartments. I've scaled the data to a mean of 0 and standard deviation 1 as it helps to interpret the impact of each variable.

The correct way to consider coefficients is that all else being equal, a unit movement in the variable has the coefficient amount of impact on the dependent variable. Since I have scaled the data this isn't so obvious but what I am looking at instead are that variables with positive coefficients contribute to prices and variables with negative coefficients detract from prices, with the scale roughly determining how much they would move.

```{r echo = FALSE,message =FALSE, warning=FALSE, out.width = "100%"}
house_lm <- readRDS("house_lm.rds")

house_2006_lm_coef <- as_tibble(house_lm[["coefficients"]],rownames = "Variable") %>%
    mutate_if(is.numeric,round,4) %>%
    mutate(`House Estimate` = Estimate,
           `House P-Value` = `Pr(>|t|)`) %>%
    select(1,6,7)

unit_lm <- readRDS("unit_lm.rds")

unit_2006_lm_coef <- as_tibble(unit_lm[["coefficients"]],rownames = "Variable") %>%
    mutate_if(is.numeric,round,4) %>%
    mutate(`Apartment Estimate` = Estimate,
           `Apartment P-Value` = `Pr(>|t|)`) %>%
    select(1,6,7)

lm_coef <- house_2006_lm_coef %>%
    left_join(unit_2006_lm_coef, by = "Variable")

lm_coef %>%
  mutate(`House Estimate` = cell_spec(`House Estimate`, "html",
                                      background = case_when(`House Estimate` > 0 &
                                                               `House P-Value` < 0.05 ~ "#a7faad",
                                                             `House Estimate` < 0 &
                                                               `House P-Value` < 0.05 ~ "#faada7",
                                                             TRUE ~ "#bebebe")),
         `Apartment Estimate` = cell_spec(`Apartment Estimate`, "html",
                                      background = case_when(`Apartment Estimate` > 0 &
                                                               `Apartment P-Value` < 0.05 ~ "#a7faad",
                                                             `Apartment Estimate` < 0 &
                                                               `Apartment P-Value` < 0.05 ~ "#faada7",
                                                             TRUE ~ "#bebebe"))) %>%
  kable(format = "html", escape = F, align = c("lrrrr")) %>%
  kable_styling(bootstrap_options = c("condensed"))
```

What this table shows is that several variables have a positive impact on property prices as they increase in value, these are:

* Year
* The proportion of senior citizens
* The proportion of units
* Dwelling density
* SEIFA Index of Relative Socio-Economic Advantage and Disadvantage
* SEIFA Index of Education and Occupation
* SEIFA Index of Economic Resources

The first is fairly obvious. Over the last 20 years there has been a lot of growth so the year is positively correlated with price increases. The proportion of senior citizens has a moderate impact, perhaps they are using their superannuation to buy nicer houses. The proportion of units and dwelling density suggests that as suburbs become more dense their prices increase, but this may be a function of other things occuring, such as new train stations significantly improving a corridor but also demanding higher density living in the area. Finally the three remaining SEIFA indexes all suggest positive increases in prices.

Of the remaining variables, population increases appear to be positive for apartments but slightly negative for houses, the proportion of public transport is curious as it is strongly positive for houses but even more strongly negative for apartments. There might be something worth looking into in that, perhaps it is a case of variable interdependence with population or density measures. Finally bicycles or walking is fairly negligible in both cases and probably shouldn't make the important variable cut.